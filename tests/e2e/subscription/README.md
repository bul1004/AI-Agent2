# Subscription テスト一覧

Stripe 連携のサブスクリプション機能の E2E テストをまとめています。

| ファイル                                        | 確認事項                                         | 主なテストケース                                                               |
| ----------------------------------------------- | ------------------------------------------------ | ------------------------------------------------------------------------------ |
| [subscription.spec.ts](./subscription.md)       | サブスクリプションモーダル表示、チェックアウト開始 | モーダル表示、Businessプラン詳細、Stripeリダイレクト、未ログイン・組織未選択時 |

## テスト実行

```bash
# subscription ディレクトリ全体を実行
npx playwright test tests/e2e/subscription/

# 特定のファイルのみ実行
npx playwright test tests/e2e/subscription/subscription.spec.ts
```

## 使用するページオブジェクト

| クラス        | 用途                                     |
| ------------- | ---------------------------------------- |
| `BillingPage` | サブスクリプションモーダルの操作・検証   |

## 前提条件

- `STRIPE_SECRET_KEY` / `STRIPE_PRICE_ID_BUSINESS` が設定されていること
- Stripe テスト環境が設定済みであること
- 各テストは独立して実行可能（テストごとに新規ユーザー・組織を作成）
- テスト後は `cleanupTestUser` でクリーンアップを実行

## 契約中ユーザーのテスト

契約中ステータスの UI を確認するには、以下のいずれかが必要です:

```bash
# 1. シードスクリプトでテストデータを作成
npx tsx scripts/seed-stripe-test-data.ts

# 2. または、DB に直接サブスクリプションレコードを作成
```

---

## Stripe Checkout UI について

`checkout.stripe.com` の画面操作は自動 E2E の対象外にしています。

**理由:**

- クロスオリジン iframe / UI 変更が多く、Playwright での安定性が低い
- テストがフレークしやすく、CI の信頼性を下げる

**自動 E2E でカバーする範囲:**

- サブスクリプションモーダルの表示
- Business プラン表示
- チェックアウト開始（Stripe へのリダイレクト確認）

**手動確認が必要な範囲:**

- Stripe UI の支払いフロー（カード入力、決済完了）
- Webhook 連携による DB 更新
- カスタマーポータルでのサブスクリプション管理
